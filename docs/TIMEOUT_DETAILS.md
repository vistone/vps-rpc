# QUIC超时详细分析

## 为什么服务端没有报错？

### 超时发生的位置

1. **客户端超时**（35秒）：
   - 发生在 `OpenStreamSync(ctx)` 
   - 错误：`timeout: no recent network activity`
   - 客户端等待服务端接受流，但35秒内没有收到响应

2. **服务端超时**（5秒，新修复）：
   - 发生在 `AcceptStream(ctx)` 
   - 如果5秒内没有新流到达，会超时并continue（不关闭连接）
   - **之前没有记录日志，所以看不到错误**

### 超时场景分析

#### 场景1：网络层超时（最常见）
```
客户端: OpenStreamSync(35s) 
  ↓ 发送流创建请求（UDP包）
  ↓ [UDP包丢失或延迟]
  ↓
服务端: AcceptStream(5s) 超时 → continue（无日志）
  ↓
客户端: 35秒后超时 → 返回错误
```
**结果**：服务端看不到错误（因为没收到请求），客户端超时失败

#### 场景2：服务端AcceptStream超时
```
客户端: OpenStreamSync(35s) 
  ↓ 发送流创建请求
  ↓ [服务端正在处理其他流，AcceptStream被阻塞]
  ↓
服务端: AcceptStream(5s) 超时 → 记录日志，continue
  ↓ [客户端还在等待]
  ↓
客户端: 35秒后超时 → 返回错误
```
**结果**：服务端记录超时日志，客户端也超时失败

#### 场景3：流创建成功但处理超时
```
客户端: OpenStreamSync(35s) 成功
  ↓ 发送请求数据
  ↓ [服务端处理缓慢]
  ↓
服务端: handleStreamWithConn 处理中...
  ↓ 读取数据超时（3秒）或其他错误
  ↓
客户端: 等待响应，35秒后超时
```
**结果**：服务端可能有处理日志，客户端超时失败

## 修复方案

### 已修复
1. ✅ 服务端AcceptStream添加5秒超时，避免无限阻塞
2. ✅ 记录AcceptStream超时日志，便于诊断

### 需要进一步优化
1. ⚠️ 调整超时时间匹配：
   - 客户端OpenStreamSync: 35秒
   - 服务端AcceptStream: 5秒（太短）
   - **建议**：服务端AcceptStream超时增加到10-15秒
   
2. ⚠️ 增加网络层错误日志：
   - 记录UDP连接状态
   - 记录流创建失败的具体原因

3. ⚠️ 优化UDP缓冲区（系统级）：
   - 当前只有416 kiB，需要7168 kiB
   - 需要root权限调整

